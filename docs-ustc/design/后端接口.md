# 后端接口

`makemigrations` `migrate` `runserver`三连后，通过 http://127.0.0.1:8000/docs/ 即可访问生成的接口文档。
我也上传了一份静态的接口文档，放在了 http://home.ustc.edu.cn/~zhangdexin/api.html 上面，不过因为是静态的，所以不能用来测试接口。

数据库目前用的是默认sqlite（并且随时可能变数据库格式），文件管理是直接存储在`backend/files/`文件夹下面（可以通过`settings.py`的`MEDIA_ROOT`配置）。

认证方式是SessionAuthentication，并且开了CSRF，我个人测试的结果是通过浏览器文档页面进行post等不安全操作时会报CSRF错误，但如果用测试工具发请求并且把Cookie中的`csrftoken`放到头部的`X-CSRFToken`里面就能验证通过。
我不清楚为啥用文档页面测试就没法验证，如果有大佬知道为啥的话请给我讲讲。

## 用户管理

通过`/api/users`获取和修改所有用户的资源（Restful方式）。
这里对不同用户进行了区分：如果是管理员，可以获取所有信息也可以操作所有信息；如果是普通用户，获取其他人的信息时会过滤掉密码等私密信息，可以操作自己的信息但不能操作别人的信息。

通过POST `/api/user/login`，提供用户名和明文密码验证登录，成功后返回用户信息，并且会自动给cookie设置SessionID和CSRFToken。

通过GET `/api/user/logout`，直接登出。

然后还有统一身份认证登录功能（POST `/api/user/ustc-login`）和注册功能（POST `/api/user/signup`），都**尚未实现**，相关接口仍有待确定。

## 文件管理

<del>

通过`/api/files/`获取和修改所有的文件。

这部分**完全没处理**，uuid需要手动指定，上传应该可以通过multipart/form-data类型的请求就可以完成，也不需要任何权限。

之后应该是需要重做的，可以考虑的方向包括：

- 可以只允许上传而不能修改，上传的时候可以自动生成UUID、计算文件大小
- 需要考虑上传的文件的层次，比如这个文件是属于哪个题目或是提交的
- 支持从URL获取文件

总之之后得和lzt商量一下文件管理的方式问题。

</del>

通过POST `/api/files`上传文件，后端会自动将该文件进行存储，并分配文件ID。

通过GET `/api/files/{id}`直接下载文件。

管理员可以GET `/api/files`获得所有文件的列表，暂时无删除功能。

## 题目、提交、评测

通过`/api/problems/`获取题目信息，通过`/api/problem-testcases/`获取测试点信息。
因为题目和测试点是一对多的关系，所以每个测试点有一个外键作为题目ID，然后题目可以获取到它拥有的测试点。
我不知道这个API设计有没有问题，以后可能还要再改。

目前测试点没有区分是第几个，题目的创建者也是可以随便改的，之后都需要处理一下。

通过`/api/submissions/`获取提交信息，提交信息是只读的，每个提交`Submission`会包含其提交的每个测试点的结果`SubmissionResult`。
给出信息时还会计算测试得分（也就是每个测试点的分数之和）。

通过POST `/api/submit/`进行提交，需要给出题目ID和本次提交的文件UUID列表。
这个功能还**没有实现**。

然后评测功能我设想是提交后会调用`judge.py`里面的`judge(submission)`函数，给一个提交信息，然后该函数会去获取该题测试点列表，并将相应评测任务分配给评测服务器。评测服务器评测完成后直接把结果写到`SubmissionResult`的数据库里即可，不需要反馈给`Submission`的数据库，前端可以比较该题有哪些测试点和该提交有哪些结果，就知道有没有评测完。
这方面的设计还需要进一步沟通。
